{% extends "base.html" %}
{% load q %}

{% block title %}
{{title}}
{% endblock %}

{% block head %}
<style>
.task.deleted span {
  color: #DDD;
  text-decoration: line-through;
}
.task .delete-task {
	display: none;
	color: #F66;
	cursor: pointer;
  text-decoration: none;
}
	.task:hover .delete-task {
		display: inline;
	}
  .task.deleted .delete-task:after {
    content: "(undo)";
  }

#project-members .admin {
  font-style: italic;
  font-size: 85%;
}
#project-members .you {
  font-weight: bold;
  font-size: 85%;
}

ul {
    -moz-column-count: 2;
    -moz-column-gap: 30px;
    -webkit-column-count: 2;
    -webkit-column-gap: 30px;
    column-count: 2;
    column-gap: 30px;
    list-style-type: none;
}

.module_box {
  border: 3px solid green; 
  width:110px;
  height: 120px; 
  padding:4px;
  text-align:center;
  margin-right: 20px;
  float: left;
}

section {
    width: 100%;
    height: 120px;
    margin: auto;
    padding: 10px;
}

</style>
{% endblock %}

{% block body %}
<h1 style="margin: 1em 0 0 0">{{title}}</h1>

<div class="row">

  <div class="col-sm-3 col-sm-push-9">
    {% if project %}
    <div class="well">
      {% if project_has_members_besides_me %}
        <div style="margin-bottom: 1em">
          <h3 style="margin: 0 0 .5em 0">Members</h3>
          <div id="project-members">
            {% for pmbr in project_members %}
              <div>
                {{pmbr.user}}
                {% if pmbr.is_admin %}<span class="admin">admin</span>{% endif %}
                {% if pmbr.user == request.user %}<span class="you">you</span>{% endif %}
              </div>
            {% endfor %}
          </div>
        </div>
      {% endif %}

      {% if send_invitation.can_add_invitee_to_team %}
        <div>
          <button class="btn btn-warning" onclick="return invite_user_into_project();">Invite to Project ...</button>
        </div>
      {% endif %}

      {% if open_invitations %}
        <div id="open-invitations-container">
          <h3>Invitations waiting for a response...</h3>
          <div class="invitation-list">
          {% for inv in open_invitations %}
            <p data-invitation-id="{{inv.id}}">
              You invited {{inv.to_display}} {{inv.purpose}} on {{inv.created|date}}.
              (<a href="#" onclick="return cancel_invitation(this, function() { if ($('#open-invitations-container .invitation-list p').length == 0) { $('#open-invitations-container').remove(); } });">cancel</a>)
            </p>
          {% endfor %}
          </div>
        </div>
      {% endif %}
    </div>
    {% endif %}
  </div>

  <div class="col-sm-9 col-sm-pull-3">

    {% if tasks or can_begin_module %} {# dont show if no permission to start a module #}
    <h2>
      {% if project %}Modules you are editing
      {% else %}Modules{% endif %}
    </h2>
    {% for task in tasks %}
      <p class="task" data-id="{{task.id}}">
        <span>
      	 <a href="{{task.get_absolute_url}}{% if not task.is_finished %}/start{% endif %}">{{task.render_title}}</a> ({{task.get_status_display}})
        </span>
      	<i class="delete-task glyphicon glyphicon-trash"></i>
      </p>
    {% empty %}
      <p>You have not started any modules in this project.</p>
    {% endfor %}
    {% endif %}

    {% if others_tasks|length %}
      <h2>Other modules in this project (edited by others)</h2>
      {% for task in others_tasks %}
        <p class="task" data-id="{{task.id}}">
          <span>
          	<a href="{{task.get_absolute_url}}">{{task.render_title}}</a> (edited by {{task.editor}}; {{task.get_status_display}})
          </span>
        	{% if is_admin %}<i class="delete-task glyphicon glyphicon-trash"></i>{% endif %}
        </p>
      {% endfor %}
    {% endif %}

    {% if discussions|length %}
      <h2>Discussions you are participating in as a guest</h2>
      {% for discussion in discussions %}
        <p><a href="{{discussion.get_absolute_url}}">{{discussion.title}}</a></p>
      {% endfor %}
    {% endif %}

    {% if can_begin_module %}
      {# can only start a new module within a project you are the admin of #}
      <hr>

      <form class="form-inline" method="post" action="/tasks/start" onsubmit="if ($('#start-module').val() == '') { alert('Select a module.'); return false; }">
        <input type="hidden" name="project" value="{{project.id}}"/>
        {% csrf_token %}
        <div class="form-group" style="margin-right: 1em">
          <label for="start-module">Start answering a new module...</label>
          <br>
          <select id="start-module" class="form-control" name="module">
            <option value="">Select...</option>
            {% for m in startable_modules %}
              <option value="{{m.id}}">{{m.title}}</option>
            {% endfor %}
          </select>
        </div>
        <div class="form-group" style="margin-right: 1em">
          <label></label>
          <br>
          <button type="submit" class="btn btn-primary">Start Module</button>
          <button class="btn btn-warning" onclick="return invite_user_to_start_module();">Invite to Answer ...</button>
        </div>
      </form>
    {% endif %}
  </div>
</div>

<!-- tab design -->
<hr>
<div>
  <ul id="finished-tabs" class="nav nav-tabs" role="tablist">
    
      <li role="presentation" class="active for-output-document"><a href="#document-1" aria-controls="document-1" role="tab" data-toggle="tab">Basic Info</a></li>
    
      <li role="presentation" class=" for-output-document"><a href="#document-2" aria-controls="document-2" role="tab" data-toggle="tab">Who's Who?</a></li>
    
    <li role="presentation"><a href="#questions" aria-controls="questions" role="tab" data-toggle="tab">Policies</a></li>
    <li role="presentation"><a href="#team" aria-controls="team" role="tab" data-toggle="tab">Team</a></li>
  </ul>

  <!-- Tab panes -->
  <div id="finished-tabs-panels" class="tab-content">
    
      <div role="tabpanel" class="tab-pane active output-document" id="document-1">
          <p>Welcome! In this section, we'll guide you through organizing basic information about your system.</p>
          <br /><br />

          <section>
          <div class="module_box">
            <p>Big<br/>Picture</p>
            <h4><span class="glyphicon glyphicon-picture"></span></h4>
            <a href="">start</a>
            or <a href="">invite</a>
          </div>

          <div class="module_box">
            <p>Online Hosting</p>
            <h4><span class="glyphicon glyphicon-cloud-upload"></span></h4>
            <a href="">start</a>
            or <a href="">invite</a>
          </div>

          <div class="module_box">
            <p>Module <br>3</p>
            <h4><span class="glyphicon glyphicon-picture"></span></h4>
            <a href="">start</a>
            or <a href="">invite</a>
          </div>
          </section>
</ul>

      </div>
    
      <div role="tabpanel" class="tab-pane  output-document" id="document-2">
          <p>Let's organize your project's Points of Contacts.</p>

      </div>
    

    <div role="tabpanel" class="tab-pane" id="questions">
        <p>Policies and procedures are guard rails for reducing problems. What are yours?</p>     
    </div>

    <div role="tabpanel" class="tab-pane" id="team">
        <p>The {{title}} team</p>     
    </div>
  </div>

</div>

<style>
#finished-tabs-panels .tab-pane {
  border-left: 1px solid #ddd;
  border-right: 1px solid #ddd;
  border-bottom: 1px solid #ddd;
  padding: 30px 15px;
}

.tab-pane {
  min-height: 400px;
}

.output-document {
  background-color: #FBF6F4;
  color: black;
}
#finished-tabs .active.for-output-document a {
  background-color: #FBF6F4;
}
</style>

<hr>
<!-- / end tab desgin -->

{% if can_begin_module %}
  {# can only start a new module within a project you are the admin of #}

  <hr>
  <h2>Available modules</h2>
  <p>Start a module or invite a colleague to start a module</p>
  <ul>
    {% for m in startable_modules %}
    <li><form class="form-inline" method="post" action="/tasks/start" onsubmit="">
      <input type="hidden" name="project" value="{{project.id}}"/>
      {% csrf_token %}
      <input type="hidden" id="start-module-{{project.id}}" class="form-control" name="module" value="{{m.id}}">
      <script>var project_invitation_info_{{project.id}} = {{send_invitation|safe}};</script>
      <button type="submit" class="btn btn-link" style="width:180px;text-align:left;">{{m.title}}</button>
      <button class="btn btn-link" onclick="return invite_user_to_start_module(project_invitation_info_{{project.id}});"><span class="glyphicon glyphicon-envelope"></span></button>
    </form>
  </li>
  {% endfor %}
  </ul>



{% endif %}

{% endblock %}

{% block scripts %}
<script>
var project_invitation_info = {{send_invitation|json}};

$(function() {
	$('.task .delete-task').click(function() {
    var task_node = $(this).parent('p');
		var task_id = task_node.attr('data-id');
    var task_is_deleted = task_node.hasClass('deleted');
    ajax_with_indicator({
     url: '{% url "task_change_state" %}',
     method: "POST",
     data: {
      id: task_id,
      state: (task_is_deleted ? 'undelete' : 'delete')
     },
     success: function(res) {
       task_node.toggleClass('deleted', !task_is_deleted);
     }
    });
	})
})

function invite_user_into_project() {
  var info = project_invitation_info;
  show_invite_modal(
    'Invite To Project Team (' + info.project_title + ')',
    'Invite a colleague to join this project team.',
    info,
    'Please join the project team for ' + info.project_title + '.',
    {
      project: info.project_id,
      add_to_team: "1"
    },
    function() { window.location.reload() }
  );

  return false;
}

function invite_user_to_start_module() {
  var info = project_invitation_info;

  var m = $('#start-module');
  if (m.val() == '') {
    alert('Select a module.');
    return false;
  }

  var mt = m.find('option[value=' + m.val() + ']').text();

  show_invite_modal(
    'Start a Module (' + info.project_title + ')',
    'Invite a colleague to answer the module ' + mt + '.',
    info,
    'Can you give me a hand completing the module ' + mt + ' for ' + info.project_title + '?',
    {
      project: info.project_id,
      into_new_task_module_id: m.val()
    },
    function() { window.location.reload() }
  );

  return false;
}

</script>
{% endblock %}